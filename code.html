<!DOCTYPE html>
<html lang="en">
<head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>Soil pHix</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <!-- bootstrap css -->
   <link rel="stylesheet" href="css/bootstrap.min.css">
   <!-- style css -->
   <link rel="stylesheet" href="css/style.css">
   <link rel='stylesheet' href='/css/github-markdown.css' />
   <!-- Responsive-->
   <link rel="stylesheet" href="css/responsive.css">
   <!-- fevicon -->
   <link rel="icon" href="images/fevicon.png" type="image/gif" />
   <!-- Tweaks for older IEs-->
   <link rel="stylesheet" href="css/owl.carousel.min.css">
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <link rel="stylesheet" href="css/bootstrap-datepicker.min.css">
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
      </head>
      <!-- body -->
      <body class="main-layout inner_page">
         <!-- loader  -->
         <div class="loader_bg">
            <div class="loader"><img src="images/loading.gif" alt="#"/></div>
         </div>
         <!-- end loader -->
         <div class="full_bg">
            <!-- header -->
            <header class="header-area">
               <div class="container">
                  <div class="row d_flex">
                     <div class=" col-md-3 col-sm-3">
                     </div>
                     <div class="col-md-9 col-sm-9">
                        <div class="navbar-area">
                           <nav class="site-navbar">
                              <ul>
                                 <li><a href="index.html">Home</a></li>
                                 <li><a href="about.html">About</a></li>
                                 <li><a class="active" href="code.html">code</a></li>
                                 <li><a href="power.html">Power calculations</a></li>
                              </ul>
                              <button class="nav-toggler">
                                 <span></span>
                              </button>
                           </nav>
                        </div>
                     </div>
                  </div>
               </div>
            </header>
            <!-- end header inner -->
         </div>
         <!-- end banner -->
         <!-- services -->
         <div class="services">
            <div class="container">
               <div class="row">
                  <div class="col-md-12">
                    <div class="titlepage text_align_center ">
                     <h2>Our code</h2>
                  </div>
               </div>
            </div>
            <div class="WebsiteCode">
               <pre><code> 
#include &lt;math.h&gt;

#define SensorPin A1
#define Offset -0.3
#define LED 13
#define samplingInterval 20
#define printInterval 800
#define ArrayLength 20
#define CO2ReadInterval 1000
#define CO2_SAMPLE_COUNT 60 // 15 minutes * 4 samples per minute
#define CO2_STANDARD_AVG 40000 // According to a study published in the Journal of Environmental Science and Health, the CO2 concentration in soil respiration
// of common bean (Phaseolus vulgaris L.) with an average of 1.3 percent.

const unsigned long SoilInteractionTimeForGlucose = 15000;//5 * 60 * 60 * 1000; //Five hours the delay for the soil after glucose seceration
const unsigned long SoilInteractionTime = 3000;//1 * 60 * 60 * 1000; //One our the delay for the soil after the sulphate or lime seceration
const unsigned long FlowRate = 5.59; //The flowrate of the pump is 5.59 mL/S, or 20.12 L/H
const unsigned long NeutralizingAgentForLime = 0.0389; //this is the Constant value we got from the relation pH in lime = C*V (3.89*10^-2)
const unsigned long NeutralizingAgentForSulphate = 0.125; //this is the Constant value we got from the relation in sulphate pH = C*V (1.25*10^-1)
const unsigned long glucosePumpTime = 30400; 
/* For each 1 g of the soil, it should obtain 35mg of glucose, As SOIL MASS is 7600 g, So, desired glucose mass is 266 g, density of the glucose is 1.56 g/cm^-3
then the volume desired of glucose for the soil is 170 mL, As the flow rate of the pump is 5.59 mL/S, the glucose pump time is (V/Q) V for Volume desired, Q for flowrate
So the pump Time is equal to (170/5.59) = 30.4 S
*/

const float pHStandardLevel = 6.5;
const float PH_LOW = 6;
const float PH_HIGH = 7.5;

float sensorValue;
float CO2Voltage;
float ppm;
float avgCO2;
float newPHValue;
float pHValue;
float pHIndicator;
float SecerationVolume;
float pHdesired;
float pumpTime;

int pHArray[ArrayLength];
int pHArrayIndex = 0;
int pumpGlucose = 3;  
int pumpLime = 4;   
int pumpSulphate = 5;   

void SulphatePumpTime(){
pHdesired = pHStandardLevel - pHIndicator; // to get the exact change in the pH that we will fix
SecerationVolume = pHdesired / NeutralizingAgentForSulphate;
/* Because the pH desired is directly proportional with the SecerationVolume, So, pH desired = Constant (C) "which is Neutralizing Agent" * SecerationVolume
From our experiments, C = 0.125, So, the Seceration volume is pHdesired/C "NeutralizingAgentForSulphate" */
pumpTime = SecerationVolume / FlowRate; // From the relation of T = V / Q as T is the time, V is the volume, Q is the flow rate
return pumpTime;
}

void LimePumpTime(){
pHdesired = pHIndicator - pHStandardLevel; // to get the exact change in the pH that we will fix, we changed the pHindicator with the pHstandard place to return positive value
SecerationVolume = pHdesired / NeutralizingAgentForLime;
/* Because the pH desired is directly proportional with the SecerationVolume, So, pH desired = Constant (C) "which is Neutralizing Agent" * SecerationVolume
From our experiments, C = 0.0389, So, the Seceration volume is pHdesired/C "NeutralizingAgentForLime" */
pumpTime = SecerationVolume / FlowRate; // From the relation of T = V / Q as T is the time, V is the volume, Q is the flow rate
return pumpTime;
}


void runPHsensorForTime(unsigned long TimeToRun) {
unsigned long startTime = millis();
while (millis() - startTime < TimeToRun){
float pHValue = checkpH(); 
   } 
}

double averageArray(int* arr, int number) {
int i;
int max, min;
double avg;
long amount = 0;
if (number <= 0) {
Serial.println("Error number for the array to averaging!\n");
return 0;
}
if (number < 5) {
for (i = 0; i < number; i++) {
amount += arr[i];
}
avg = amount / number;
return avg;
} else {
if (arr[0] < arr[1]) {
min = arr[0];
max = arr[1];
} else {
min = arr[1];
max = arr[0];
}
for (i = 2; i < number; i++) {
if (arr[i] < min) {
amount += min;
min = arr[i];
} else {
if (arr[i] > max) {
amount += max;
max = arr[i];
} else {
amount += arr[i];
              }
           }
        }
        avg = (double)amount / (number - 2);
     }
     return avg;
  }

  float checkpH() {
    static unsigned long samplingTime = millis();
    static unsigned long printTime = millis();
    static float pHValue, voltage;

    if (millis() - samplingTime > samplingInterval) {
     pHArray[pHArrayIndex++] = analogRead(SensorPin);
     if (pHArrayIndex == ArrayLength) pHArrayIndex = 0;
     voltage = averageArray(pHArray, ArrayLength) * 5.0 / 1024;
     pHValue = 3.5 * voltage + Offset;
     samplingTime = millis();
  }

  if (millis() - printTime > printInterval) {
     Serial.print("Voltage:");
     Serial.print(voltage, 2);
     Serial.print("    pH value: ");
     Serial.println(pHValue, 2);
     digitalWrite(LED, digitalRead(LED) ^ 1);
     printTime = millis();
  }

  return pHValue;
}

float averageCO2Reading() {
 float totalCO2 = 0;
 for (int i = 0; i < CO2_SAMPLE_COUNT; i++) {
  float currentCO2 = co2reading();
  totalCO2 += currentCO2;
  delay(CO2ReadInterval);
}
return totalCO2 / CO2_SAMPLE_COUNT;
}

float co2reading() {
 sensorValue = analogRead(A0);
 CO2Voltage = sensorValue * (5.0 / 1023.0);
 ppm = 116.6020682 * pow((CO2Voltage / 3.34), -3.096);
 Serial.print("CO2 Level (ppm): ");
 Serial.println(ppm);
 return ppm;
}

void activatePump(int pump, unsigned long duration) {
 digitalWrite(pump, HIGH);
 delay(duration);
 digitalWrite(pump, LOW);
}

void ReCheck(){
   float newPHValue = checkpH();
   
   if (newPHValue >= PH_LOW && newPHValue <= PH_HIGH ){ //this is made by me
   Serial.println("new ph value after check is :");
   Serial.print(newPHValue);
   activatePump(pumpGlucose, glucosePumpTime);
   delay(SoilInteractionTimeForGlucose);
   while (true) {
      avgCO2 =   averageCO2Reading();     //I CHANGED THIS TO MAKING THE TEST 
      if (avgCO2 >= CO2_STANDARD_AVG) {
       Serial.println("Problem solved, pH and CO2 are normal");
       break;
    } 
    else {
       Serial.println("Error 1, (pH is optimized now, but the microorganisms quantity is low)");
       Serial.println("Process 1, (Reactivation of the glucose to ))");
       activatePump(pumpGlucose, glucosePumpTime);
       delay(SoilInteractionTimeForGlucose); // here should be a recheck for the co2 of the system
    }
 }
}
else {
 Serial.println("Error 2, (pH is not optimized)");
 Serial.println("Process 2, (Reapeating the procedures to neutrilize the pH");
}
}

void setup() {
 pinMode(pumpGlucose, OUTPUT);
 pinMode(pumpLime, OUTPUT);
 pinMode(pumpSulphate, OUTPUT);
 pinMode(A0, INPUT);
 pinMode(SensorPin, INPUT);
 pinMode(LED, OUTPUT);
 Serial.begin(9600);
 Serial.println("pH meter experiment!");
 digitalWrite(pumpGlucose, LOW);
 digitalWrite(pumpLime, LOW);
 digitalWrite(pumpSulphate, LOW);
}

void loop() { 
 pHValue = 5.8;//checkpH();  // Continuously update pH value//ichanged them to be tested
 pHIndicator = pHValue;  // Update indicator
 // runPHsensorForTime(10000); // this will be tested if it can be removed
 pHIndicator = pHValue;
 if (pHIndicator > PH_HIGH || pHIndicator < PH_LOW){
   Serial.println("pH change is detected and the current value is: ");
   Serial.print(pHIndicator);
   activatePump(pumpGlucose, glucosePumpTime);
   delay(SoilInteractionTimeForGlucose);
   float avgCO2 = averageCO2Reading(); 
   Serial.println("The average CO2 is: ");
   Serial.print(avgCO2);
   
   if (pHIndicator  > PH_HIGH && avgCO2 < CO2_STANDARD_AVG) {
     Serial.println("pHIndicator > 7 && avgCO2 < CO2_STANDARD_AVG and the ph value is :");
     Serial.print(pHIndicator);
     SulphatePumpTime();
     Serial.println("The pump will be activated for: ");
     Serial.print(pumpTime);
     activatePump(pumpSulphate, pumpTime);
     delay(SoilInteractionTime);
     ReCheck();
  }

  else if (pHIndicator < PH_LOW && avgCO2 < CO2_STANDARD_AVG) {
    Serial.println("pHIndicator < 7 && avgCO2 < CO2_STANDARD_AVG and the ph value is :");
    Serial.print(pHIndicator);
    LimePumpTime();
    Serial.println("The pump will be activated for: ");
    Serial.print(pumpTime);
    activatePump(pumpLime, pumpTime);
    delay(SoilInteractionTime);
    ReCheck();
 }
}     
}
</code></pre>
</div>
<div class="row">
   <div class="col-md-4">
      <div id="ho_shad" class="services_box text_align_left">
      </div>
   </div>
   <div class="col-md-4">
      <div id="ho_shad" class="services_box text_align_left">
      </div>
   </div>
   <div class="col-md-4">
      <div id="ho_shad" class="services_box text_align_left">
      </div>
   </div>
</div>
</div>
</div>
<!-- end services -->
<!--  footer -->
<footer>
   <div class="footer">
      <div class="container">
      </div>
      <div class="copyright">
         <div class="container">
            <div class="row">
               <div class="col-md-12">
                  <div class="follow text_align_center">
                     <h3>Follow Us</h3>
                     <ul class="social_icon ">
                        <li><a href="Javascript:void(0)"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                        <li><a href="Javascript:void(0)"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                        <li><a href="Javascript:void(0)"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
                        <li><a href="Javascript:void(0)"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
                     </ul>
                  </div>
               </div>
               <div class="col-md-12">
                  <p>© 2023 All Rights Reserved. Design by Ziad Amir S'24 R3S <a href="https://html.design/"> </a></p>
               </div>
            </div>
         </div>
      </div>
   </div>
</footer>
<!-- end footer -->
<!-- Javascript files-->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery-3.0.0.min.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/bootstrap-datepicker.min.js"></script>
<script src="js/custom.js"></script>
</body>
</html>
